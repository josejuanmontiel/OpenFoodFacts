<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="papaparse.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

  <title>Vite App</title>
</head>

<body>
  <div id="qr-reader" style="width:500px"></div>
  <div id="qr-reader-results"></div>
  <script>
    var matriz; 

      async function procesarCSV(url) {
        try {
          // 1. Fetch del archivo Gzip
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`Error al obtener el archivo: ${response.statusText}`);
          }

          // 2. Leer el cuerpo de la respuesta como ArrayBuffer
          const arrayBuffer = await response.arrayBuffer();

          // 3. Descomprimir el archivo usando Pako
          const decompressedData = pako.inflate(arrayBuffer, { to: 'string' });

          // 4. Procesar el CSV descomprimido con PapaParse
          Papa.parse(decompressedData, {
            header: true, // Si tu CSV tiene encabezados
            worker: true, // Usar workers para mejorar la eficiencia
            step: function (results) {
              console.log("Fila procesada:", results.data); // Procesar fila por fila
            },
            complete: function (resutls) {
              console.log("Procesamiento del CSV completado.");
              matriz = results.data;
            },
            error: function (error) {
              console.error("Error al procesar el CSV:", error);
            }
          });
        } catch (error) {
          console.error("Ocurrió un error:", error);
        }
      }

    // IIFE asíncrona para ejecutar await en el bloque global
    (async () => {
      console.log("Esperando los datos...");
      
      // Iniciar la función para procesar el CSV
      await procesarCSV('/spain_products.csv.gz');
    })();

    function docReady(fn) {
      // see if DOM is already available
      if (document.readyState === "complete"
        || document.readyState === "interactive") {
        // call on next available tick
        setTimeout(fn, 1);
      } else {
        document.addEventListener("DOMContentLoaded", fn);
      }
    }

    docReady(function () {
      var resultContainer = document.getElementById('qr-reader-results');
      var lastResult, countResults = 0;
      function onScanSuccess(decodedText, decodedResult) {
        if (decodedText !== lastResult) {
          ++countResults;
          lastResult = decodedText;
          // Handle on success condition with the decoded message.
          console.log(`Scan result ${decodedText}`, decodedResult.result.text);

          const claveABuscar = decodedResult.result.text;
          const subArrayEncontrado = matriz.find(subArray => subArray[0] === claveABuscar);
          console.log(subArrayEncontrado); // [20, "María", "Doctora"]

          resultContainer.innerHTML = 
            '<div>CODE: '+decodedResult.result.text+'</div>'+
            '<div>Image: <img src="'+subArrayEncontrado[5]+'"/></div>';
        }
      }

      var html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader", { fps: 10, qrbox: 250 });
      html5QrcodeScanner.render(onScanSuccess);
    });
  </script>
</body>

</html>